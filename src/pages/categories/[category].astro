---
import { getCollection } from 'astro:content';
import RootLayout from '../../layouts/RootLayout.astro';
import PostCard from '../../components/blog/PostCard.astro';
import { BLOG_INFO } from '../../consts';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	const uniqueCategories = [...new Set(allPosts.flatMap((post) => post.data.categories || []))];

	return uniqueCategories.map((category) => {
		const filteredPosts = allPosts.filter((post) => 
			post.data.categories?.includes(category)
		).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

		const categorySlug = category
			.toLowerCase()
			.replace(/\s+/g, '-')
			.replace(/\//g, '-')
			.replace(/[^a-z0-9-]/g, '');

		return {
			params: { category: categorySlug },
			props: { posts: filteredPosts, originalCategory: category },
		};
	});
}

const { category } = Astro.params;
const { posts, originalCategory } = Astro.props;
---

<RootLayout 
	title={`${originalCategory} - ${BLOG_INFO.title}`} 
	description={`Posts categorized with ${originalCategory}`}
>
	<div class="category-page">
		<h3>{originalCategory}</h3>
		<p class="count">{posts.length} {posts.length === 1 ? 'post' : 'posts'} found</p>
		
		<div class="posts-grid">
			{
				posts.map((post) => (
					<PostCard post={post} />
				))
			}
		</div>
	</div>
</RootLayout>

<style>
	.category-page {
		width: 100%;
	}
	
	.count {
		color: var(--muted-foreground);
		margin-bottom: 2rem;
		font-size: 0.95rem;
	}

	.posts-grid {
		display: grid;
		gap: 1.5rem;
	}
</style>